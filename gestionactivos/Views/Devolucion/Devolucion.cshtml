@model IEnumerable<gestionactivos.Models.DevolucionModel>

<h1>Devolucion</h1>
<link href="~/css/site.css" rel="stylesheet" />
<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <form method="post" action="@Url.Action("Devolucion", "Devolucion")">
                <label for="Cedula">Cédula Funcionario</label>
                <input name="cedula" type="text" class="form-control" />
                <br />
                <button type="submit" class="btn btn-primary">Consultar Cédula</button>
            </form>
        </div>
    </div>
    <div id="message-container"></div>
</div>
<br />
@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger">
        @ViewBag.ErrorMessage
    </div>
}
@{
    var funcionarios = ViewBag.Funcionarios as List<gestionactivos.Models.DevolucionModel>;
}
@if (funcionarios != null)
{
    <div class="table-responsive">
        <table id="DevolucionTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>Encargado Cedula</th>
                    <th>Encargado Nombres</th>
                    <th>Encargado Apellidos</th>
                    <th>Encargado Correo</th>
                    <th>Responsable Cedula</th>
                    <th>Responsable Nombre</th>
                    <th>Responsable Apellido</th>
                    <th>Responsable Correo</th>
                    <th>Fecha Movimiento</th>
                    <th>id Articulo</th>
                    <th>Categoria Articulo</th>
                    <th>Modelo Articulo</th>
                    <th>Serial Articulo</th>
                    <th>Placa Articulo</th>
                    <th>Devolver</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var articuloGroup in funcionarios.GroupBy(m => m.idArticulo))
                {
                    var articulo = articuloGroup.First();

                    <tr data-id="@articulo.idArticulo">
                        <td>@articulo.EncargadoCedula</td>
                        <td>@articulo.EncargadoNombres</td>
                        <td>@articulo.EncargadoApellidos</td>
                        <td>@articulo.EncargadoCorreo</td>
                        <td>@articulo.ResponsableCedula</td>
                        <td>@articulo.ResponsableNombre</td>
                        <td>@articulo.ResponsableApellido</td>
                        <td>@articulo.ResponsableCorreo</td>
                        <td>@articulo.FechaMovimiento?.ToString("yyyy-MM-dd")</td>
                        <td>@articulo.idArticulo</td>
                        <td>@articulo.CategoriaArticulo</td>
                        <td>@articulo.ModeloArticulo</td>
                        <td>@articulo.SerialArticulo</td>
                        <td>@articulo.PlacaArticulo</td>

                        <td>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#DevolverEquipo" id="@articulo.idMovimientos">Devolver</button>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="14">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>id Adicional</th>
                                            <th>Categoria Adicional</th>
                                            <th>Modelo Adicional</th>
                                            <th>Serial Adicional</th>
                                            <th>Placa Adicional</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var adicional in articuloGroup)
                                        {
                                            <tr>
                                                <td>@adicional.idAdicional</td>
                                                <td>@adicional.CategoriaAdicional</td>
                                                <td>@adicional.ModeloAdicional</td>
                                                <td>@adicional.SerialAdicional</td>
                                                <td>@adicional.PlacaAdicional</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>

                    <!-- Modal -->
                    <div class="modal fade" id="DevolverEquipo" tabindex="-1" aria-labelledby="devolverEquipoLabel" aria-hidden="true" data-bs-backdrop="static">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="devolverEquipoLabel">Devolver Equipo</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="comentarios" class="form-label">Comentarios:</label>
                                        <textarea class="form-control" id="comentarios" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-danger" id="confirmarDevolucion">Devolver</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="DevolverDetalle" tabindex="-1" aria-labelledby="devolverDetalleLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="devolverDetalleLabel">Devolver Detalle</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="devolverDetalleBody">
                                    <div class="mb-3">
                                        <canvas id="signatureCanvas" width="500" height="200" style="border:1px solid #000;"></canvas>
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="clearCanvas">Limpiar Firma</button>
                                    <button type="button" class="btn btn-primary" id="saveSignature">Guardar Firma</button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                }
            </tbody>
        </table>
    </div>
}

@section script{
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let signaturePad;

            const devolverButtons = document.querySelectorAll('button[data-bs-toggle="modal"]');

            devolverButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const idMovimientos = this.id;
                    const modalTitle = document.getElementById('devolverEquipoLabel');
                    modalTitle.textContent = `Devolver Equipo - ID: ${idMovimientos}`;

                    const row = this.closest('tr');
                    const encargadoId = row.querySelector('td:nth-child(1)').textContent;
                    const responsableId = row.querySelector('td:nth-child(5)').textContent;

                    const modalBody = document.querySelector('.modal-body');
                    modalBody.innerHTML = `
                            <p>¿Está seguro de que desea devolver el equipo?</p>
                            <div class="mb-3">
                                <label for="comentarios" class="form-label">Comentarios:</label>
                                <textarea class="form-control" id="comentarios" rows="3"></textarea>
                            </div>
                        `;

                    if (encargadoId) {
                        const buttonEncargado = document.createElement('button');
                        buttonEncargado.className = 'btn btn-danger me-2';
                        buttonEncargado.textContent = 'Devolver para Encargado';
                        buttonEncargado.onclick = function () {
                            abrirSegundoModal(idMovimientos, encargadoId, 'Encargado');
                        };
                        modalBody.appendChild(buttonEncargado);
                    }

                    if (responsableId) {
                        const buttonResponsable = document.createElement('button');
                        buttonResponsable.className = 'btn btn-danger';
                        buttonResponsable.textContent = 'Devolver para Responsable';
                        buttonResponsable.onclick = function () {
                            abrirSegundoModal(idMovimientos, responsableId, 'Responsable');
                        };
                        modalBody.appendChild(buttonResponsable);
                    }
                });
            });

            function abrirSegundoModal(idMovimientos, funcionarioId, tipoFuncionario) {
                const modalTitle = document.getElementById('devolverDetalleLabel');
                modalTitle.textContent = `Devolver Detalle - ID Movimiento: ${idMovimientos}`;

                const modalBody = document.getElementById('devolverDetalleBody');
                modalBody.innerHTML = `
                        <div class="mb-3">
                            <canvas id="signatureCanvas" width="500" height="200" style="border:1px solid #000;"></canvas>
                        </div>
                        <button type="button" class="btn btn-secondary" id="clearCanvas">Limpiar Firma</button>
                        <button type="button" class="btn btn-primary" id="saveSignature">Guardar Firma</button>
                    `;

                // Inicializar Signature Pad
                const canvas = document.getElementById('signatureCanvas');
                signaturePad = new SignaturePad(canvas);

                // Botón para limpiar la firma
                const clearButton = document.getElementById('clearCanvas');
                clearButton.addEventListener('click', () => {
                    signaturePad.clear();
                });

                // Botón para guardar la firma
                const saveButton = document.getElementById('saveSignature');
                saveButton.addEventListener('click', () => {
                    guardarFirma(funcionarioId);
                });

                // Mostrar el segundo modal
                const devolverDetalleModal = new bootstrap.Modal(document.getElementById('DevolverDetalle'));
                devolverDetalleModal.show();
            }

            function guardarFirma(funcionarioId) {
                if (signaturePad.isEmpty()) {
                    alert("Por favor, firme en el recuadro.");
                    return;
                }

                const dataURL = signaturePad.toDataURL();

                // Enviar la firma al servidor
                $.ajax({
                    url: '@Url.Action("SaveSignatureFuncionario", "Devolucion")',
                    type: 'POST',
                    data: {
                        CedulaFuncionario: funcionarioId,
                        dataURL: dataURL
                    },
                    success: function (response) {
                        if (response.success) {
                            alert("Firma guardada exitosamente.");
                        } else {
                            alert("Error al guardar la firma: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Error en la solicitud de guardado de firma.");
                    }
                });
            }
        });
    </script>


}